요약: 이 함수는 CS를 낮춰 SPI로 슬레이브에 4바이트(더미 0x00)를 순차 전송하고, 동시에 MISO로 들어오는 4바이트를 받아 union의 바이트 배열에 채운 뒤 그 4바이트를 하나의 long 값으로 반환합니다. 핵심은 SPI.transfer가 전송과 수신을 동시에 수행한다는 점입니다.
코드 구조와 역할
- union 선언
union { long val; byte b[4]; } data;는 같은 메모리 공간을 4바이트 배열(b[0]..b[3])과 32비트 정수(val) 로 공유합니다. 이 덕분에 바이트 단위로 받은 데이터를 채운 뒤 data.val로 한 번에 읽을 수 있습니다. 바이트 순서(엔디언)는 MCU에 따라 달라질 수 있으므로 결과 해석 시 주의해야 합니다.


ATmega2560 마이크로컨트롤러는 리틀 엔디안(little-endian) 바이트 순서를 따릅니다. 
이는 여러 바이트로 구성된 데이터(예: 16비트 int 또는 32비트 long)를 메모리에 저장할 때, 가장 낮은 주소에 최하위 바이트(Least Significant Byte, LSB)가 먼저 저장되는 방식을 의미합니다.
예를 들어, 0x12345678이라는 32비트 정수가 있을 때, 리틀 엔디안 시스템에서는 메모리 주소 100부터 다음과 같이 저장됩니다: 
주소	저장된 값
100	0x78
101	0x56
102	0x34
103	0x12

ESP32-S3 칩셋은 리틀 엔디안(Little Endian) 바이트 순서를 따릅니다. 
ESP32-S3에는 Xtensa® 32비트 LX7 마이크로프로세서가 탑재되어 있으며, 이 프로세서는 데이터 및 명령어 버스 모두 리틀 엔디안 방식으로 데이터를 처리합니다. 
리틀 엔디안 방식은 여러 바이트로 구성된 데이터(예: 32비트 정수)를 메모리에 저장할 때 최하위 바이트(Least Significant Byte, LSB)부터 낮은 메모리 주소에 저장하는 방식입니다. 
참고로, 네트워크 통신 시에는 일반적으로 빅 엔디안(Big Endian) 방식(네트워크 바이트 순서)을 사용하므로, ESP32-S3에서 네트워크로 데이터를 전송하거나 수신할 때는 바이트 순서를 변환해야 할 수도 있습니다. 이를 위해 __builtin_bswap32와 같은 내장 함수를 활용할 수 있습니다. 


SPI 데이터 흐름 단계별 설명
- CS 핀 LOW: digitalWrite(CS_PIN, LOW);로 슬레이브 선택. 슬레이브는 이제 클럭과 데이터에 반응할 준비를 합니다.
- for 루프(4회): 각 반복에서 SPI.transfer(0x00)를 호출합니다. 이 함수는 마스터가 MOSI로 0x00을 보내는 동안 슬레이브가 MISO로 보내는 바이트를 반환합니다. 즉, 전송과 수신이 동시 발생하며 반환값을 data.b[i]에 저장합니다.
- 내부적으로 마스터는 SCK(클럭)으로 8번의 펄스를 생성하고, 각 펄스마다 한 비트가 MOSI로 나가고 한 비트가 MISO로 들어옵니다.
- CS 핀 HIGH: digitalWrite(CS_PIN, HIGH);로 통신 종료. 슬레이브는 더 이상 선택되지 않습니다.
- 값 반환: return data.val;로 4바이트를 하나의 long으로 읽어 반환합니다. 바이트 인덱스 0이 가장 먼저 수신된 바이트인지, 또는 마지막인지는 MCU의 바이트 정렬과 통신 규약에 따라 달라집니다.



요약: 이 코드는 32비트 encoderPos를 바이트 단위로 분해해 한 번에 한 바이트씩 SPDR에 써서 슬레이브(MCU가 슬레이브일 경우) 또는 마스터(역방향)로 전송 대기시키는 동작을 합니다. idx는 0→3 순환하며 4바이트를 순차 송출합니다.
동작 개요
- 데이터 준비: union으로 data.val = encoderPos;를 하면 같은 메모리 공간에 4바이트가 채워져 data.b[0]..data.b[3]로 각각 접근할 수 있습니다. 이 방식으로 바이트 분해와 재조합이 가능합니다.
- 인덱스 관리: static byte idx는 함수 호출마다 유지되어 0,1,2,3을 순환하며 각 호출에서 다른 바이트를 전송합니다. 4번째 이후엔 0으로 리셋됩니다.

전송 타이밍과 SPDR 역할
- SPDR에 쓰기: SPDR = data.b[idx];는 AVR의 SPI 데이터 레지스터에 바이트를 로드하는 동작입니다. 이 쓰기는 내부 시프트 레지스터로 데이터를 옮기고, 실제 물리적 전송은 클럭(SCK)이 발생할 때 이루어집니다.
- 전송 완료 플래그: 전송이 끝나면 상태 레지스터(SPSR)의 SPIF 비트가 세트되며, 이때 SPDR을 읽어 수신 바이트를 얻습니다.
- 동시 송수신 특성: SPI는 클럭을 기준으로 마스터가 타이밍을 만들고, 전송과 수신이 동시에 일어나는 전이중 통신입니다. 즉, 한 쪽이 데이터를 보내려면 상대 쪽에서 클럭을 제공해야 실제로 물리선상으로 바이트가 오가게 됩니다.



