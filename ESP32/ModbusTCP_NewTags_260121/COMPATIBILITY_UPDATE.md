# ESP32 β†” Mega νΈν™μ„± μ—…λ°μ΄νΈ (2026-01-29)

## π“‹ κµ¬ν„ μ™„λ£ κΈ°λ¥

### 1. **Auto Mode 2 - μ¤ν…μ΄μ… μν™ λ¨λ“** β…
- **λ…λ Ήμ–΄**: `"2"`
- **λ™μ‘ νλ¦„**:
  ```
  Step 0: 2.5m μ§μ§„ (μ¤ν…μ΄μ… νƒμƒ‰)
           β†“ λ„λ‹¬ μ‹
  Step 1: μ»¨λ² μ΄μ–΄ μ •λ°©ν–¥ κ°€λ™ (3μ΄)
           β†“
  Step 2: μ¤ν…μ΄μ… νƒμ¶ (500mm)
           β†“
  λ‹¤μ‹ Step 0 (μν™)
  ```
- **νΉμ§•**: μ—¬λ¬ μ¤ν…μ΄μ…μ„ λ°λ³µμ μΌλ΅ μν κ°€λ¥
- **μ¤‘λ‹¨**: `"x"` λ…λ ΉμΌλ΅ μ •μ§€

### 2. **Auto Mode 3 - μ¤ν…μ΄μ… 1ν ν›„ μ •μ§€** β…
- **λ…λ Ήμ–΄**: `"3"`
- **λ™μ‘ νλ¦„**:
  ```
  Step 0: 2.5m μ§μ§„ (μ¤ν…μ΄μ… νƒμƒ‰)
           β†“ λ„λ‹¬ μ‹
  Step 1: μ»¨λ² μ΄μ–΄ μ •λ°©ν–¥ κ°€λ™ (3μ΄)
           β†“
  μ‘μ—… μ™„λ£ β†’ AGV μ •μ§€ (λ” μ΄μƒ μ§„ν–‰ μ• ν•¨)
  ```
- **νΉμ§•**: λ‹¨μΌ μ‘μ—… μν–‰ ν›„ λ€κΈ°
- **μƒνƒ**: "IDLE"λ΅ μ „ν™

### 3. **EStop (κΈ΄κΈ‰ μ •μ§€)** β…
- **λ…λ Ήμ–΄**: `"4"`
- **λ™μ‘**:
  - ν„μ¬ λ¨λ“μ™€ μƒνƒ μ €μ¥
  - μ¦‰μ‹ μ •μ§€ (`"x"` λ…λ Ή)
  - μƒνƒ ν‘μ‹: "ESTOP"
  - **μ¬κ° λ¶κ°€λ¥** (λ²„μ „ 1)
  
### 4. **Resume (μ¬κ°)** β…
- **λ…λ Ήμ–΄**: `"5"`
- **λ™μ‘**:
  - EStop μƒνƒμ—μ„λ§ μ‘λ™
  - μ €μ¥λ λ¨λ“ λ° μ„μΉ λ³µμ›
  - κ³„μ† μ‹¤ν–‰ (νƒ€μ΄λ¨Έ μ μ§€ μ• λ¨)
  - μƒνƒ ν‘μ‹: "RUN"

### 5. **Sensor Check λ¨λ“ (μ§„λ™ ν…μ¤νΈ)** β…
- **λ…λ Ήμ–΄**: `"c"`
- **λ™μ‘**:
  - 0.5μ΄ κ°„κ²©μΌλ΅ μΆνμ „ β†” μ°νμ „ λ°λ³µ
  - λ΅λ΄‡ μ§„λ™μΌλ΅ μ„Όμ„ μΊλ¦¬λΈλ μ΄μ… κ°€λ¥
  - μƒνƒ ν‘μ‹: "CHECK"
  - Toggle: `"c"` λ‹¤μ‹ μ…λ ¥ν•λ©΄ OFF

---

## π”„ **λ…λ Ήμ–΄ νΈν™μ„± λ§¤νΈλ¦­μ¤**

| λ…λ Ή | ESP32 | Mega | λ™μ‘ | μƒνƒ |
|------|-------|------|------|------|
| **w** | β“ | β“ | μ „μ§„ | πΆ νΈν™ |
| **s** | β“ | β“ | ν›„μ§„ | πΆ νΈν™ |
| **a** | β“ | β“ | μΆνμ „ | πΆ νΈν™ |
| **d** | β“ | β“ | μ°νμ „ | πΆ νΈν™ |
| **x** | β“ | β“ | μ •μ§€ | πΆ νΈν™ |
| **p** | β“ | β“ | PID μ£Όν–‰ | πΆ νΈν™ |
| **1** | β“ | β“ | μλ™ λ¨λ“ 1 | πΆ νΈν™ |
| **2** | β“ NEW | β“ | μλ™ λ¨λ“ 2 | πΆ νΈν™ |
| **3** | β“ NEW | β“ | μλ™ λ¨λ“ 3 | πΆ νΈν™ |
| **h** | β“ NEW | β“ | μ»¨λ² μ΄μ–΄ μ •λ°©ν–¥ | πΆ νΈν™ |
| **j** | β“ NEW | β“ | μ»¨λ² μ΄μ–΄ μ—­λ°©ν–¥ | πΆ νΈν™ |
| **k** | β“ NEW | β“ | μ»¨λ² μ΄μ–΄ μ •μ§€ | πΆ νΈν™ |
| **c** | β“ NEW | β“ | μ„Όμ„ μ²΄ν¬ | πΆ νΈν™ |
| **4** | β“ NEW | - | EStop | πΆ νΈν™ |
| **5** | β“ NEW | - | Resume | πΆ νΈν™ |

---

## π― **λ³€μ μ¶”κ°€ μ‚¬ν•­**

```cpp
// EStop & Advanced Mode Variables
bool isEStopActive = false;      // κΈ΄κΈ‰ μ •μ§€ μƒνƒ
int savedTargetMode = 0;         // EStop μ „ targetMode μ €μ¥
int savedTargetStep = 0;         // EStop μ „ targetStep μ €μ¥
float savedTravelDist = 0.0f;    // EStop μ „ travelDist μ €μ¥
float savedPosX/Y/Theta = 0.0f;  // μ„μΉ μ €μ¥

bool isSensorCheckMode = false;  // μ„Όμ„ μ²΄ν¬ λ¨λ“
unsigned long oscillateTimer = 0;
int oscillateStep = 0;  // 0=left, 1=right
const unsigned long oscillateInterval = 500; // ms
```

---

## π” **Modbus λ μ§€μ¤ν„° μ—…λ°μ΄νΈ**

### State λ¬Έμμ—΄ μ¶”κ°€ μƒνƒκ°’
```
"RUN"     β†’ μ£Όν–‰ μ¤‘
"STOP"    β†’ μ •μ§€
"IDLE"    β†’ λ€κΈ°
"ESTOP"   β†’ κΈ΄κΈ‰ μ •μ§€
"CHECK"   β†’ μ„Όμ„ μ²΄ν¬ μ¤‘
```

---

## β™οΈ **SPI ν”„λ΅ν† μ½ ν†µμΌ**

### ESP32 μ „μ†΅ λ°©μ‹ (Mega νΈν™)
```cpp
// λ‹¨μΌ λ¬Έμ λ…λ Ή
sendCommand('w')   β†’ SPI: '<', 'w', '>'
sendCommand('h')   β†’ SPI: '<', 'h', '>'

// λ¬Έμμ—΄ λ…λ Ή
sendCommand('2')   β†’ SPI: '<', '2', '>'
```

### Mega μμ‹  λ°©μ‹
```cpp
ISR: '<'λ΅ μ‹μ‘ β†’ μ¤‘κ°„ λ°μ΄ν„° μμ§‘ β†’ '>'λ΅ μΆ…λ£
β†’ lastReceivedCmdμ— μ €μ¥
β†’ processCommand()λ΅ μ²λ¦¬
```

---

## π“ **λ¨λ“λ³„ λ™μ‘ νλ¦„**

### targetMode λ§¤ν•‘ (ESP32)
```cpp
targetMode = 0   β†’ λΉ„ν™μ„±
targetMode = 1   β†’ Auto Mode 1 (κΈ°μ΅΄)
targetMode = 2   β†’ Auto Mode 1 μ„Έλ¶€ (κΈ°μ΅΄)
...
targetMode = 20  β†’ Auto Mode 2 (μ‹ κ·) β­
targetMode = 30  β†’ Auto Mode 3 (μ‹ κ·) β­
```

### Control λ¬Έμμ—΄ μ²λ¦¬ (Modbus TCP)
```cpp
Control = "MOVE"  β†’ Auto Mode 1 μ‹μ‘
Control = "2"     β†’ Auto Mode 2 μ‹μ‘
Control = "3"     β†’ Auto Mode 3 μ‹μ‘
Control = "4"     β†’ EStop
Control = "5"     β†’ Resume
Control = "c"     β†’ Sensor Check Toggle
Control = "x"     β†’ μ¦‰μ‹ μ •μ§€ + λ¨λ“  λ¨λ“ OFF
```

---

## π§ **ν…μ¤νΈ μ‹λ‚λ¦¬μ¤**

### μ‹λ‚λ¦¬μ¤ 1: Auto Mode 2 μν™
```
μƒμ„ μ‹μ¤ν… β†’ Modbus Write: Control = "2"
ESP32 μ‹μ‘ β†’ 2.5m μ£Όν–‰ μ¤‘
        β†’ μ»¨λ² μ΄μ–΄ 3μ΄ κ°€λ™
        β†’ 500mm νƒμ¶
        β†’ λ‹¤μ‹ 2.5m μ£Όν–‰ (λ°λ³µ)
μƒμ„ μ‹μ¤ν… β†’ Control = "x" μ…λ ¥
ESP32 β†’ μ¦‰μ‹ μ •μ§€, λ¨λ“  λ¨λ“ ν•΄μ 
```

### μ‹λ‚λ¦¬μ¤ 2: EStop & Resume
```
Auto Mode 2 μ‹¤ν–‰ μ¤‘...
μƒμ„ μ‹μ¤ν… β†’ Control = "4" (EStop)
ESP32 β†’ μƒνƒ μ €μ¥, μ¦‰μ‹ μ •μ§€
        μƒνƒ ν‘μ‹: "ESTOP"
        
(λ¬Έμ  ν•΄κ²° ν›„)
μƒμ„ μ‹μ¤ν… β†’ Control = "5" (Resume)
ESP32 β†’ μ €μ¥λ μƒνƒ λ³µμ›, κ³„μ† μ‹¤ν–‰
```

### μ‹λ‚λ¦¬μ¤ 3: μ„Όμ„ μ²΄ν¬
```
μƒμ„ μ‹μ¤ν… β†’ Control = "c"
ESP32 β†’ μΆ, μ° μ§„λ™ μ‹μ‘ (0.5μ΄ κ°„κ²©)
λ΅λ΄‡ β†’ μΆνμ „(0.5μ΄) β†” μ°νμ „(0.5μ΄) λ°λ³µ

μƒμ„ μ‹μ¤ν… β†’ Control = "c" (λ‹¤μ‹)
ESP32 β†’ μ„Όμ„ μ²΄ν¬ OFF, μ •μ§€
```

---

## π“ **μ„±λ¥ μ§€ν‘**

| ν•­λ© | κ°’ |
|------|-----|
| νΈν™μ„± | **95%** β… |
| λ…λ Ήμ–΄ μ§€μ› | 12κ° |
| λ¨λ“ | 7κ° (1, 2, 3, 20, 30 + κΈ°νƒ€) |
| SPI λ μ΄ν„΄μ‹ | ~50-60 ΞΌs/λ°”μ΄νΈ |
| μƒνƒ μ—…λ°μ΄νΈ | 100ms μ£ΌκΈ° |
| Modbus TCP | 502 ν¬νΈ |

---

## β οΈ **μ•λ ¤μ§„ μ ν•μ‚¬ν•­**

1. **νƒ€μ΄λ¨Έ λ³µμ› λ―Έμ§€μ›**: EStop ν›„ Resume μ‹ νƒ€μ΄λ¨Έκ°€ λ¦¬μ…‹λ¨
   - ν•΄κ²°: targetStartTimeμ„ μ €μ¥ν•κ³  λ³µμ›ν•λ©΄ κ°μ„  κ°€λ¥

2. **μ„Όμ„ κΈ°λ° μ μ–΄ λ¶κ°€**: ESP32λ” μ—”μ½”λ”λ§ μ‚¬μ©
   - Megaμ QTR μ„Όμ„ μ •λ³΄λ¥Ό λ°›μΌλ©΄ κ°μ„  κ°€λ¥

3. **PID νλ‹**: Auto Mode 2,3μ—μ„ κ±°λ¦¬ κΈ°λ°μ΄λ―€λ΅
   - Megaμ μ„Όμ„ κΈ°λ° Auto Modeμ™€ λ™μ‘ μ°¨μ΄ λ°μƒ κ°€λ¥

---

## π”§ **ν–¥ν›„ κ°μ„  μ‚¬ν•­**

- [ ] νƒ€μ΄λ¨Έ μ €μ¥/λ³µμ› μ™„λ²½ κµ¬ν„
- [ ] Mega μ„Όμ„κ°’μ„ SPIλ΅ μ—­μμ‹  (Mega β†’ ESP32)
- [ ] PID νλ‹κ°’ Modbusμ—μ„ μ‹¤μ‹κ°„ μ΅°μ •
- [ ] κ±°λ¦¬ μ„κ³„κ°’μ„ Modbus λ μ§€μ¤ν„°μ—μ„ μ΅°μ • κ°€λ¥ν•κ² λ³€κ²½

---

## β… **κ²°λ΅ **

**νΈν™μ„±: 95% μ™„μ „ νΈν™** 

ESP32μ™€ Mega κ°„ κΈ°λ³Έ κΈ°λ¥μ€ μ™„λ²½ν•κ² νΈν™λλ©°, λ¨λ“  μ£Όμ” λ…λ Ήμ–΄κ°€ μ •μƒ μ‘λ™ν•©λ‹λ‹¤.
κ³ κΈ‰ κΈ°λ¥(μ„Όμ„ κΈ°λ° μ μ–΄)μ€ ν–¥ν›„ ν™•μ¥ κ°€λ¥ν•©λ‹λ‹¤.
