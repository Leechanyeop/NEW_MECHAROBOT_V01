#include <Open62541-Arduino.h>
// 기타 와이파이 및 엔코더 라이브러리

// 1. 전역 변수 선언
double x = 0.0, y = 0.0, theta = 0.0;
long prevLeftTick = 0, prevRightTick = 0;

// 2. OPC UA 서버 및 노드 ID 정의
UA_Server *server;
UA_NodeId xNodeId, yNodeId, thetaNodeId;

void setup() {
  // 와이파이 연결 및 엔코더 설정
  
  // OPC UA 서버 시작 및 변수(Node) 등록
  // "AGV_Position_X" 등의 이름으로 노드 생성
}

void loop() {
  server.run(); // OPC UA 통신 유지

  // 3. 주기적으로 좌표 계산 (예: 50ms 마다)
  if (isTimeForCalculation()) {
    long currentLeftTick = getLeftEncoder();
    long currentRightTick = getRightEncoder();
    
    // 위에서 설명한 운동학 공식으로 x, y, theta 갱신
    calculateOdometry(currentLeftTick, currentRightTick);
    
    // 4. OPC UA 노드 값 업데이트
    UA_Variant value;
    
    UA_Variant_setScalar(&value, &x, &UA_TYPES[UA_TYPES_DOUBLE]);
    UA_Server_writeValue(server, xNodeId, value);
    
    UA_Variant_setScalar(&value, &y, &UA_TYPES[UA_TYPES_DOUBLE]);
    UA_Server_writeValue(server, yNodeId, value);
    
    // Theta도 동일하게 업데이트
  }
}