ì¢‹ìŠµë‹ˆë‹¤ ğŸ™‚ ì´ì œ ESP32ê°€ í´ë¼ì´ì–¸íŠ¸ë¡œ ì™¸ë¶€ OPC UA ì„œë²„ì— ë°ì´í„°ë¥¼ í‘¸ì‹œí•˜ë©´ì„œ ë™ì‹œì— ì„œë²„ì˜ ë…¸ë“œë¥¼ êµ¬ë…í•˜ëŠ” êµ¬ì¡°ë¥¼ ì„¤ëª…í•´ ë“œë¦´ê²Œìš”.

ğŸ”¹ êµ¬ì¡° ê°œë…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        Wi-Fi        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ESP32       â”‚  <----------------> â”‚   OPC UA Server   â”‚
â”‚               â”‚                     â”‚ (PC/Cloud/SCADA)  â”‚
â”‚  - ì„¼ì„œ ì½ê¸°   â”‚   ë°ì´í„° í‘¸ì‹œ       â”‚   - ë°ì´í„° ì €ì¥     â”‚
â”‚  - ë°ì´í„° í‘¸ì‹œ â”‚ ------------------> â”‚   - ì œì–´ ëª…ë ¹ ë°œí–‰  â”‚
â”‚  - ë…¸ë“œ êµ¬ë…   â”‚ <------------------ â”‚   - ë…¸ë“œ ê°’ ë³€ê²½    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


- í‘¸ì‹œ(Push): ESP32ê°€ í´ë¼ì´ì–¸íŠ¸ë¡œì„œ ì„œë²„ì˜ íŠ¹ì • ë…¸ë“œì— ì£¼ê¸°ì ìœ¼ë¡œ ì„¼ì„œ ë°ì´í„°ë¥¼ ê¸°ë¡
- êµ¬ë…(Subscription): ESP32ê°€ ì„œë²„ì˜ ì œì–´ ë…¸ë“œë¥¼ êµ¬ë… â†’ ì„œë²„ê°€ ê°’ì„ ë³€ê²½í•˜ë©´ ESP32ê°€ ì•Œë¦¼ì„ ë°›ì•„ ë™ì‘

ğŸ”¹ ë™ì‘ íë¦„
- ESP32ê°€ ì˜¨ë„ ì„¼ì„œë¥¼ ì½ìŒ â†’ ì„œë²„ì˜ Temperature ë…¸ë“œì— ê°’ ê¸°ë¡ (í‘¸ì‹œ)
- ì„œë²„ëŠ” Fan_Control ë…¸ë“œë¥¼ ê°€ì§€ê³  ìˆìŒ
- ESP32ëŠ” Fan_Control ë…¸ë“œë¥¼ êµ¬ë… â†’ ê°’ì´ ë³€ê²½ë˜ë©´ ì½œë°± ì‹¤í–‰
- ì„œë²„ê°€ Fan_Control = trueë¡œ ë³€ê²½ â†’ ESP32ê°€ ì•Œë¦¼ì„ ë°›ê³  íŒ¬ì„ ì¼¬

ğŸ”¹ ì½”ë“œ ì˜ˆì œ (ê°œëµ, open62541 ê¸°ë°˜)
#include "open62541.h"
#include "driver/gpio.h"

#define FAN_PIN 2

static UA_Boolean running = true;

// ì„œë²„ ë…¸ë“œ ë³€ê²½ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°±
static void subscriptionCallback(UA_Client *client, UA_UInt32 subId,
                                 void *subContext, UA_UInt32 monId,
                                 void *monContext, UA_DataValue *value) {
    if(UA_Variant_hasScalarType(&value->value, &UA_TYPES[UA_TYPES_BOOLEAN])) {
        UA_Boolean fanState = *(UA_Boolean*)value->value.data;
        gpio_set_level(FAN_PIN, fanState);
    }
}

void app_main(void) {
    gpio_set_direction(FAN_PIN, GPIO_MODE_OUTPUT);

    // OPC UA í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    UA_Client *client = UA_Client_new();
    UA_ClientConfig_setDefault(UA_Client_getConfig(client));

    // ì„œë²„ ì—°ê²°
    UA_StatusCode retval = UA_Client_connect(client, "opc.tcp://192.168.0.10:4840");
    if(retval != UA_STATUSCODE_GOOD) return;

    // Subscription ìƒì„±
    UA_CreateSubscriptionRequest request = UA_CreateSubscriptionRequest_default();
    UA_CreateSubscriptionResponse response = UA_Client_Subscriptions_create(client, request, NULL, NULL, NULL);

    // Fan_Control ë…¸ë“œ êµ¬ë…
    UA_NodeId fanNodeId = UA_NODEID_STRING(2, "Fan_Control");
    UA_MonitoredItemCreateRequest monRequest =
        UA_MonitoredItemCreateRequest_default(fanNodeId);
    UA_Client_MonitoredItems_createDataChange(client, response.subscriptionId,
                                              UA_TIMESTAMPSTORETURN_BOTH,
                                              monRequest, NULL, subscriptionCallback, NULL);

    // ì£¼ê¸°ì ìœ¼ë¡œ ì„¼ì„œ ë°ì´í„° í‘¸ì‹œ
    while(running) {
        double temperature = 25.0; // ì‹¤ì œ ì„¼ì„œ ê°’ ì½ê¸°
        UA_Variant value;
        UA_Variant_setScalar(&value, &temperature, &UA_TYPES[UA_TYPES_DOUBLE]);
        UA_NodeId tempNodeId = UA_NODEID_STRING(2, "Temperature");
        UA_Client_writeValueAttribute(client, tempNodeId, &value);

        vTaskDelay(5000 / portTICK_PERIOD_MS); // 5ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    }

    UA_Client_disconnect(client);
    UA_Client_delete(client);
}

î·™î·š

ğŸ”¹ ìš”ì•½
- ESP32 â†’ ì„œë²„: ì„¼ì„œ ë°ì´í„°ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í‘¸ì‹œ (í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„ ë…¸ë“œ ì“°ê¸°)
- ì„œë²„ â†’ ESP32: ESP32ê°€ ì„œë²„ ë…¸ë“œë¥¼ êµ¬ë… â†’ ê°’ ë³€ê²½ ì‹œ ì•Œë¦¼ ë°›ì•„ ë™ì‘ ìˆ˜í–‰
- ê²°ê³¼: ESP32ëŠ” ë°ì´í„°ë¥¼ ë³´ë‚´ë©´ì„œ ë™ì‹œì— ì„œë²„ì˜ ì œì–´ ëª…ë ¹ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆìŒ
